version: '3.8'

services:
  dev_init:
    container_name: ma_init
    build: ./py
    networks:
      - textrepo_network
      - elucidate_network
    environment:
      TEXTREPO_HOST: http://textrepo-app:8080
      TEXT_STORE_PATH: /usr/src/app/data/1728/10mrt-v1/1728-textstore.json
      ANNO_STORE_PATH: data/1728-06-19-annotationstore.json
    volumes:
      - ../untangle2elucidate/:/usr/src/app/
      - ./scripts/wait-for-it.sh:/scripts/wait-for-it.sh
      - ./init/textrepo:/usr/src/app/textrepo
      - ./init/init.sh:/usr/src/app/init.sh
    command: [
        "/scripts/wait-for-it.sh", "textrepo-app:8080", "--timeout=0", "--",
        "/scripts/wait-for-it.sh", "elucidate:8080", "--timeout=0", "--",
        "./init.sh"
    ]

  nginx:
    container_name: ma_nginx
    image: nginx:1.19
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
    networks:
      - annotator_network
      - elucidate_network
      - textrepo_network
    ports:
      - "8000:8000"
    depends_on:
      - annotator

  annotator:
    container_name: ma_annotator
    image: micro-annotator-gui:latest
    build: ./gui
    volumes:
      - ./gui/public:/annotator/public
      - ./gui/src:/annotator/src
      - ./gui/tsconfig.json:/annotator/tsconfig.json
    networks:
      - annotator_network
    environment:
      REACT_APP_CREATOR: ${REACT_APP_CREATOR}
      REACT_APP_ELUCIDATE_HOST: http://localhost:8000/elucidate
      REACT_APP_PLACEHOLDER_SEARCH_ID: ${REACT_APP_PLACEHOLDER_SEARCH_ID}
      REACT_APP_TEXTREPO_HOST: http://localhost:8000/textrepo
    command: npm start
    expose:
      - 3000

networks:
  annotator_network:
  elucidate_network:
    external: true
    name: elucidate_network
  textrepo_network:
    external: true
    name: textrepo_network
